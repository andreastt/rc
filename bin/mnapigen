#!/bin/bash

set -ex

BRANCH=inbound
SRC=/home/$USER/src/gecko
DEST=/tmp/marionette-api-builder

function log {
	logger -t marionette-api-builder "$@"
}

log "pruning worktrees"
git -C $SRC worktree prune

if [ ! -d $DEST ]
then
	log "no destination checkout, creating a worktree"
	git -C $SRC worktree add $DEST $BRANCH
fi

log "fetching and rebasing $BRANCH"
git -C $DEST pull

head=$(git -C $DEST rev-parse HEAD)
log "building docs from $head"

cd $DEST
log "building docs..."

rc=0
./mach marionette doc || rc=$?

if [ $rc != 0 ]
then
	log "failed building docs, please check stderr"
	git -C $DEST reset --hard
	exit 1
fi

git -C $DEST commit -am "No bug: Generate Marionette API docs. r=me NPOTB"
git -C $DEST push -n

log "done"
