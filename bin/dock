#!/bin/bash

set -e

sleep 0.5

username=ato

if [[ $ACTION == "add" ]]
then
	DOCKED=1
	logger -t dock "docked"
elif [[ $ACTION == "remove" ]]
then
	DOCKED=0
	logger -t dock "undocked"
else
	logger -t dock "unknown"
	echo "please set env var $ACTION to 'add' or 'remove'"
	exit 1
fi

# invoke from xsetup with NO_KDM_REBOOT
# otherwise we will end up in a KDM reboot loop
NO_KDM_REBOOT=0
for p in $*
do
	case $p in
		"NO_KDM_REBOOT") NO_KDM_REBOOT=1 ;;
		"SWITCH_TO_LOCAL") DOCKED=0 ;;
	esac
done

function switch_to_local {
	export DISPLAY=$1
	logger -t dock "switching off DP2-1 and switching on eDP1"
	su $username -c '/usr/bin/xrandr --output DP2-1 --off --output eDP1 --auto'
}

function switch_to_external {
	export DISPLAY=$1
	logger -t dock "switching off eDP1 and on DP2-1"
	su $username -c '/usr/bin/xrandr --output eDP1 --off --output DP2-1 --auto'
}

case $DOCKED in
	0) switch_to_local :0 ;;
	1) switch_to_external :0 ;;
esac

logger -t dock "restarting fvwm"
su $username -c '/usr/bin/FvwmCommand Restart'

